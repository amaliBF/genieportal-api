generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ═══════════════════════════════════════════════════════════════════════════
// ENUMS
// ═══════════════════════════════════════════════════════════════════════════

enum UserStatus {
  ACTIVE
  INACTIVE
  BANNED
  DELETED
}

enum CompanyStatus {
  PENDING
  ACTIVE
  SUSPENDED
  DELETED
}

enum JobStatus {
  DRAFT
  PENDING_REVIEW
  ACTIVE
  PAUSED
  CLOSED
  FILLED
  EXPIRED
  ARCHIVED
}

enum VideoStatus {
  PROCESSING
  ACTIVE
  REJECTED
  DELETED
}

enum MatchStatus {
  NEW
  PENDING
  VIEWED
  ACTIVE
  CHATTING
  INTERVIEW_SCHEDULED
  HIRED
  DECLINED
  REJECTED
  EXPIRED
}

enum SubscriptionPlan {
  FREE
  STARTER
  PRO
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  TRIALING
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  SYSTEM
}

enum NotificationType {
  NEW_LIKE
  NEW_MATCH
  NEW_MESSAGE
  PROFILE_VIEW
  JOB_EXPIRING
  SYSTEM
}

enum ModerationStatus {
  PENDING
  APPROVED
  REJECTED
}

// ═══════════════════════════════════════════════════════════════════════════
// NEUE ENUMS (Multi-Portal)
// ═══════════════════════════════════════════════════════════════════════════

enum PortalStatus {
  GEPLANT
  ENTWICKLUNG
  BETA
  LIVE
  PAUSIERT
  EINGESTELLT
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  REFUNDED
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELED
}

// ═══════════════════════════════════════════════════════════════════════════
// PREMIUM FEATURES ENUMS
// ═══════════════════════════════════════════════════════════════════════════

enum AlertFrequency {
  INSTANT
  DAILY
  WEEKLY
}

enum ReviewerType {
  AZUBI
  MITARBEITER
  PRAKTIKANT
  BEWERBER
}

enum ReviewStatus {
  REVIEW_PENDING
  APPROVED
  REVIEW_REJECTED
  REPORTED
}

enum SalaryType {
  HOURLY
  MONTHLY
  YEARLY
}

enum SalarySource {
  JOB_POST
  USER_SUBMITTED
  OFFICIAL
}

enum ViewSource {
  APP
  WEBSITE_SOURCE
  GOOGLE
  COMPANY_WEBSITE
  API_SOURCE
  EMAIL_SOURCE
}

enum ClickType {
  APPLY_BUTTON
  COMPANY_PROFILE
  VIDEO_PLAY
  CONTACT
  WEBSITE_LINK
}

enum InterviewType {
  IN_PERSON
  VIDEO_CALL
  PHONE
}

enum InterviewStatus {
  INTERVIEW_PENDING
  CONFIRMED
  INTERVIEW_COMPLETED
  INTERVIEW_CANCELLED
  NO_SHOW
}

// ═══════════════════════════════════════════════════════════════════════════
// KI-FEATURES & FIRMEN-TOOLS ENUMS
// ═══════════════════════════════════════════════════════════════════════════

enum BoostType {
  BOOST
  SPOTLIGHT
}

enum BoostStatus {
  BOOST_PENDING
  BOOST_ACTIVE
  BOOST_EXPIRED
  BOOST_CANCELLED
}

enum TalentSource {
  FROM_MATCH
  FROM_APPLICATION
  FROM_SEARCH
  MANUAL
}

// ═══════════════════════════════════════════════════════════════════════════
// GAMIFICATION ENUMS
// ═══════════════════════════════════════════════════════════════════════════

enum AchievementCategory {
  PROFIL
  AKTIVITAET
  MATCHES_CAT
  KOMMUNIKATION
  BEWERBUNGEN
  STREAKS
  SPEZIAL
}

enum AchievementRarity {
  COMMON
  UNCOMMON
  RARE
  EPIC
  LEGENDARY
}

// ═══════════════════════════════════════════════════════════════════════════
// SOCIAL ENUMS
// ═══════════════════════════════════════════════════════════════════════════

enum FriendshipStatus {
  FRIENDSHIP_PENDING
  ACCEPTED
  BLOCKED
}

enum VideoVisibility {
  VIS_PUBLIC
  MATCHES_ONLY
  APPLICATIONS_ONLY
  VIS_PRIVATE
}

// ═══════════════════════════════════════════════════════════════════════════
// PORTALS (Alle Genie-Portale) - NEU
// ═══════════════════════════════════════════════════════════════════════════

model Portal {
  id                    Int           @id @default(autoincrement())

  // Identifikation
  slug                  String        @unique @db.VarChar(50)
  name                  String        @db.VarChar(100)
  domain                String        @db.VarChar(100)

  // Kategorisierung
  kategorie             String        @db.VarChar(50)

  // Branding
  farbe                 String        @db.VarChar(7)
  icon                  String        @db.VarChar(10)
  beschreibung          String?       @db.VarChar(255)
  logoUrl               String?       @map("logo_url") @db.VarChar(500)

  // Status
  status                PortalStatus  @default(GEPLANT)

  // Features (welche Module aktiv)
  features              Json          @default("{}")

  // Konfiguration
  config                Json          @default("{}")

  // Timestamps
  createdAt             DateTime      @default(now()) @map("created_at")
  launchDate            DateTime?     @map("launch_date")

  // Relations
  companies             Company[]
  users                 User[]
  subscriptions         Subscription[]
  invoices              Invoice[]
  jobPosts              JobPost[]
  userBereiche          UserBereich[]
  companyBereiche       CompanyBereich[]
  auditLogs             AuditLog[]
  jobPostPortals        JobPostPortal[]
  externalJobs          ExternalJob[]

  @@map("portals")
}

// ═══════════════════════════════════════════════════════════════════════════
// CUSTOMERS (Portal-übergreifende Kunden) - NEU
// ═══════════════════════════════════════════════════════════════════════════

model Customer {
  id                    String    @id @default(uuid())

  // Basis-Daten
  name                  String    @db.VarChar(255)
  email                 String    @db.VarChar(255)
  phone                 String?   @db.VarChar(30)

  // Adresse
  street                String?   @db.VarChar(255)
  postalCode            String?   @map("postal_code") @db.VarChar(10)
  city                  String?   @db.VarChar(100)
  country               String    @default("DE") @db.VarChar(2)

  // Rechnungsdaten
  taxId                 String?   @map("tax_id") @db.VarChar(50)

  // Stripe
  stripeCustomerId      String?   @unique @map("stripe_customer_id") @db.VarChar(100)

  // Notizen
  notes                 String?   @db.Text
  tags                  Json      @default("[]")

  // Timestamps
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  companies             Company[]
  subscriptions         Subscription[]
  invoices              Invoice[]
  payments              Payment[]

  @@index([email])
  @@map("customers")
}

// ═══════════════════════════════════════════════════════════════════════════
// INVOICE (Rechnungen) - NEU
// ═══════════════════════════════════════════════════════════════════════════

model Invoice {
  id                    String        @id @default(uuid())

  portalId              Int           @default(1) @map("portal_id")
  customerId            String?       @map("customer_id")
  companyId             String?       @map("company_id")

  // Rechnungsdaten
  invoiceNumber         String?       @unique @map("invoice_number") @db.VarChar(50)
  status                InvoiceStatus @default(DRAFT)

  // Beträge
  subtotal              Decimal       @default(0) @db.Decimal(10, 2)
  taxRate               Decimal       @default(19) @map("tax_rate") @db.Decimal(5, 2)
  taxAmount             Decimal       @default(0) @map("tax_amount") @db.Decimal(10, 2)
  total                 Decimal       @default(0) @db.Decimal(10, 2)
  currency              String        @default("EUR") @db.VarChar(3)

  // Beschreibung
  description           String?       @db.Text
  lineItems             Json          @default("[]") @map("line_items")

  // Zeitraum
  periodStart           DateTime?     @map("period_start")
  periodEnd             DateTime?     @map("period_end")

  // Stripe
  stripeInvoiceId       String?       @map("stripe_invoice_id") @db.VarChar(100)

  // Timestamps
  issuedAt              DateTime?     @map("issued_at")
  dueAt                 DateTime?     @map("due_at")
  paidAt                DateTime?     @map("paid_at")
  createdAt             DateTime      @default(now()) @map("created_at")
  updatedAt             DateTime      @updatedAt @map("updated_at")

  // Relations
  portal                Portal        @relation(fields: [portalId], references: [id])
  customer              Customer?     @relation(fields: [customerId], references: [id])
  payments              Payment[]

  @@index([customerId])
  @@index([portalId])
  @@map("invoices")
}

// ═══════════════════════════════════════════════════════════════════════════
// PAYMENTS (Zahlungseingänge) - NEU
// ═══════════════════════════════════════════════════════════════════════════

model Payment {
  id                    String        @id @default(uuid())

  customerId            String        @map("customer_id")
  invoiceId             String?       @map("invoice_id")

  amount                Decimal       @db.Decimal(10, 2)
  currency              String        @default("EUR") @db.VarChar(3)

  // Payment Provider (stripe ODER paypal)
  provider              String        @default("paypal") @db.VarChar(20)
  paymentMethod         String?       @map("payment_method") @db.VarChar(50)
  status                PaymentStatus @default(PENDING)

  // Stripe IDs (optional)
  stripePaymentIntentId String?       @map("stripe_payment_intent_id") @db.VarChar(100)

  // PayPal IDs (optional)
  paypalOrderId         String?       @map("paypal_order_id") @db.VarChar(100)
  paypalCaptureId       String?       @map("paypal_capture_id") @db.VarChar(100)
  paypalSubscriptionId  String?       @map("paypal_subscription_id") @db.VarChar(100)

  failureReason         String?       @map("failure_reason") @db.Text

  createdAt             DateTime      @default(now()) @map("created_at")

  customer              Customer      @relation(fields: [customerId], references: [id])
  invoice               Invoice?      @relation(fields: [invoiceId], references: [id])

  @@index([customerId])
  @@map("payments")
}

// ═══════════════════════════════════════════════════════════════════════════
// USER_BEREICHE (User aktiviert Bereiche in der App) - NEU
// ═══════════════════════════════════════════════════════════════════════════

model UserBereich {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  portalId     Int      @map("portal_id")

  isActive     Boolean  @default(true) @map("is_active")

  // Bereichsspezifische Profildaten als JSON
  profileData  Json     @default("{}") @map("profile_data")

  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  portal       Portal   @relation(fields: [portalId], references: [id])

  @@unique([userId, portalId])
  @@map("user_bereiche")
}

// ═══════════════════════════════════════════════════════════════════════════
// COMPANY_BEREICHE (Betrieb aktiviert Bereiche) - NEU
// ═══════════════════════════════════════════════════════════════════════════

model CompanyBereich {
  id             String   @id @default(uuid())
  companyId      String   @map("company_id")
  portalId       Int      @map("portal_id")

  isActive       Boolean  @default(true) @map("is_active")

  // Separates Abo pro Bereich möglich
  subscriptionId String?  @map("subscription_id")

  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  company        Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  portal         Portal       @relation(fields: [portalId], references: [id])
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id])

  @@unique([companyId, portalId])
  @@map("company_bereiche")
}

// ═══════════════════════════════════════════════════════════════════════════
// AUDIT_LOG (Zentrale Aktivitätsverfolgung) - NEU
// ═══════════════════════════════════════════════════════════════════════════

model AuditLog {
  id                    String     @id @default(uuid())

  adminUserId           String?    @map("admin_user_id")
  portalId              Int?       @map("portal_id")

  action                String     @db.VarChar(100)
  entityType            String     @map("entity_type") @db.VarChar(50)
  entityId              String?    @map("entity_id")

  description           String     @db.Text
  oldValues             Json?      @map("old_values")
  newValues             Json?      @map("new_values")

  ipAddress             String?    @map("ip_address") @db.VarChar(45)
  userAgent             String?    @map("user_agent") @db.Text

  createdAt             DateTime   @default(now()) @map("created_at")

  adminUser             AdminUser? @relation(fields: [adminUserId], references: [id])
  portal                Portal?    @relation(fields: [portalId], references: [id])

  @@index([createdAt])
  @@map("audit_logs")
}

// ═══════════════════════════════════════════════════════════════════════════
// USERS (Jugendliche / Azubi-Suchende) - ERWEITERT
// ═══════════════════════════════════════════════════════════════════════════

model User {
  id                    String    @id @default(uuid())

  // Auth
  email                 String    @unique
  passwordHash          String    @map("password_hash")

  // Basis
  phone                 String?
  firstName             String    @map("first_name")
  lastName              String?   @map("last_name")
  displayName           String?   @map("display_name")
  birthDate             DateTime? @map("birth_date") @db.Date
  avatarUrl             String?   @map("avatar_url") @db.VarChar(500)

  // Standort
  postalCode            String?   @map("postal_code") @db.VarChar(10)
  city                  String?   @db.VarChar(100)
  latitude              Decimal?  @db.Decimal(10, 8)
  longitude             Decimal?  @db.Decimal(11, 8)
  maxDistanceKm         Int       @default(30) @map("max_distance_km")

  // Bildung
  currentSchoolType     String?   @map("current_school_type") @db.VarChar(50)
  graduationYear        Int?      @map("graduation_year")

  // Profil
  bio                   String?   @db.Text
  interests             Json?     @default("[]")
  strengths             Json?     @default("[]")
  lookingFor            String?   @map("looking_for") @db.Text
  preferredProfessions  Json?     @default("[]") @map("preferred_professions")
  preferredStartDate    DateTime? @map("preferred_start_date") @db.Date

  // Status
  status                UserStatus @default(ACTIVE)
  profileComplete       Boolean    @default(false) @map("profile_complete")
  completenessScore     Int        @default(0) @map("completeness_score")
  emailVerified         Boolean    @default(false) @map("email_verified")
  emailVerifyToken      String?    @map("email_verify_token")

  // Settings
  pushEnabled           Boolean    @default(true) @map("push_enabled")
  emailNotifications    Boolean    @default(true) @map("email_notifications")
  profileVisible        Boolean    @default(true) @map("profile_visible")

  // Consent
  termsAcceptedAt       DateTime?  @map("terms_accepted_at")
  privacyAcceptedAt     DateTime?  @map("privacy_accepted_at")
  parentConsent         Boolean    @default(false) @map("parent_consent")
  parentEmail           String?    @map("parent_email")

  // Password Reset
  passwordResetToken    String?    @map("password_reset_token")
  passwordResetExpires  DateTime?  @map("password_reset_expires")

  // Refresh Token
  refreshToken          String?    @map("refresh_token") @db.Text

  // FCM Token
  fcmToken              String?    @map("fcm_token") @db.VarChar(500)

  // SSO-Felder
  ssoEnabled            Boolean    @default(false) @map("sso_enabled")
  registeredVia         String?    @map("registered_via") @db.VarChar(100)
  lastLoginDomain       String?    @map("last_login_domain") @db.VarChar(100)
  activeDomains         Json?      @map("active_domains")
  lifePhase             String?    @map("life_phase") @db.VarChar(50)
  newsletterConsent     Boolean    @default(false) @map("newsletter_consent")
  newsletterConsentAt   DateTime?  @map("newsletter_consent_at")
  ssoRefreshToken       String?    @map("sso_refresh_token") @db.Text
  ssoRefreshTokenExp    DateTime?  @map("sso_refresh_token_exp")

  // Multi-Portal (NEU)
  portalId              Int        @default(1) @map("portal_id")

  // Gamification
  xp                    Int        @default(0)
  level                 Int        @default(1)
  currentStreak         Int        @default(0) @map("current_streak")
  longestStreak         Int        @default(0) @map("longest_streak")
  lastStreakDate        DateTime?  @map("last_streak_date") @db.Date

  // Bewerber-Video
  videoUrl              String?    @map("video_url") @db.VarChar(500)
  videoStoragePath      String?    @map("video_storage_path") @db.VarChar(500)
  videoThumbnail        String?    @map("video_thumbnail") @db.VarChar(500)
  videoDuration         Int?       @map("video_duration")
  videoVisibility       VideoVisibility @default(VIS_PUBLIC) @map("video_visibility")

  // Timestamps
  createdAt             DateTime   @default(now()) @map("created_at")
  updatedAt             DateTime   @updatedAt @map("updated_at")
  lastActiveAt          DateTime   @default(now()) @map("last_active_at")
  deletedAt             DateTime?  @map("deleted_at")

  // Relations (bestehend)
  likes                 Like[]
  companyLikes          CompanyLike[]
  matches               Match[]
  chats                 Chat[]
  messages              Message[]  @relation("UserMessages")
  notifications         Notification[]
  aiConversations       AiConversation[]
  events                Event[]

  // Relations (NEU)
  portal                Portal     @relation(fields: [portalId], references: [id])
  userBereiche          UserBereich[]

  // Premium & Social Relations
  jobAlerts             JobAlert[]
  companyReviews        CompanyReview[]
  reviewHelpfuls        ReviewHelpful[]
  companyFollows        CompanyFollow[]
  salarySubmissions     SalaryData[]
  jobPostViews          JobPostView[]
  jobPostClicks         JobPostClick[]
  careerFinderResults   CareerFinderResult[]
  userAchievements      UserAchievement[]
  friendshipsSent       Friendship[]          @relation("FriendshipSender")
  friendshipsReceived   Friendship[]          @relation("FriendshipReceiver")
  recommendationsSent   JobRecommendation[]   @relation("RecommendationSender")
  recommendationsReceived JobRecommendation[] @relation("RecommendationReceiver")
  referralCodes         ReferralCode[]
  skillTestResults      SkillTestResult[]
  talentPools           TalentPool[]
  ssoRefreshTokens      SsoRefreshToken[]
  userDocuments         UserDocument[]

  @@index([postalCode])
  @@index([status])
  @@index([email])
  @@map("users")
}

// ═══════════════════════════════════════════════════════════════════════════
// SSO_REFRESH_TOKEN (SSO Token-Rotation)
// ═══════════════════════════════════════════════════════════════════════════

model SsoRefreshToken {
  id        Int      @id @default(autoincrement())
  userId    String   @map("user_id")
  token     String   @unique @db.VarChar(512)
  device    String?  @db.VarChar(255)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("sso_refresh_tokens")
}

// ═══════════════════════════════════════════════════════════════════════════
// COMPANIES (Ausbildungsbetriebe) - ERWEITERT
// ═══════════════════════════════════════════════════════════════════════════

model Company {
  id                    String    @id @default(uuid())

  name                  String    @db.VarChar(255)
  slug                  String    @unique @db.VarChar(100)
  legalName             String?   @map("legal_name") @db.VarChar(255)

  email                 String    @db.VarChar(255)
  phone                 String?   @db.VarChar(30)
  website               String?   @db.VarChar(255)

  street                String?   @db.VarChar(255)
  postalCode            String    @map("postal_code") @db.VarChar(10)
  city                  String    @db.VarChar(100)
  latitude              Decimal?  @db.Decimal(10, 8)
  longitude             Decimal?  @db.Decimal(11, 8)

  industry              String?   @db.VarChar(100)
  industryTags          Json?     @default("[]") @map("industry_tags")

  description           String?   @db.Text
  shortDescription      String?   @map("short_description") @db.VarChar(300)
  foundedYear           Int?      @map("founded_year")
  employeeCount         String?   @map("employee_count") @db.VarChar(20)
  logoUrl               String?   @map("logo_url") @db.VarChar(500)
  coverImageUrl         String?   @map("cover_image_url") @db.VarChar(500)

  trainingSince         Int?      @map("training_since")
  totalApprentices      Int?      @map("total_apprentices")
  benefits              Json?     @default("[]")

  verified              Boolean   @default(false)
  verifiedAt            DateTime? @map("verified_at")
  taxId                 String?   @map("tax_id") @db.VarChar(50)

  subscriptionPlan      SubscriptionPlan @default(FREE) @map("subscription_plan")
  subscriptionStatus    SubscriptionStatus? @map("subscription_status")
  planValidUntil        DateTime? @map("plan_valid_until")
  stripeCustomerId      String?   @map("stripe_customer_id") @db.VarChar(100)
  stripeSubscriptionId  String?   @map("stripe_subscription_id") @db.VarChar(100)
  paypalSubscriptionId  String?   @map("paypal_subscription_id") @db.VarChar(100)
  maxJobPosts           Int       @default(1) @map("max_job_posts")
  maxVideos             Int       @default(0) @map("max_videos")

  status                CompanyStatus @default(PENDING)

  // Multi-Portal (NEU)
  portalId              Int       @default(1) @map("portal_id")
  customerId            String?   @map("customer_id")

  // Bewertungs-Aggregate
  reviewCount           Int       @default(0) @map("review_count")
  reviewAverage         Decimal   @default(0) @map("review_average") @db.Decimal(3, 2)
  recommendPercent      Int       @default(0) @map("recommend_percent")

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  deletedAt             DateTime? @map("deleted_at")

  // Relations (bestehend)
  companyUsers          CompanyUser[]
  jobPosts              JobPost[]
  videos                Video[]
  likes                 Like[]
  companyLikes          CompanyLike[]
  matches               Match[]
  chats                 Chat[]
  subscriptions         Subscription[]
  events                Event[]

  // Relations (NEU)
  portal                Portal    @relation(fields: [portalId], references: [id])
  customer              Customer? @relation(fields: [customerId], references: [id])
  companyBereiche       CompanyBereich[]
  couponRedemptions     CouponRedemption[]

  // Enterprise Features
  importLogs            ImportLog[]
  applications          Application[]
  applicationFormConfig ApplicationFormConfig?
  apiKeys               ApiKey[]
  webhooks              Webhook[]

  // Premium & Social Relations
  companyReviews        CompanyReview[]
  companyFollowers      CompanyFollow[]
  salaryData            SalaryData[]
  salaryStatistics      SalaryStatistics[]
  jobPostViews          JobPostView[]
  jobPostClicks         JobPostClick[]
  interviewSlots        InterviewSlot[]
  interviews            Interview[]
  jobBoosts             JobBoost[]
  talentPools           TalentPool[]

  @@index([postalCode])
  @@index([status])
  @@index([slug])
  @@map("companies")
}

// ═══════════════════════════════════════════════════════════════════════════
// COMPANY_USERS
// ═══════════════════════════════════════════════════════════════════════════

model CompanyUser {
  id                    String    @id @default(uuid())
  companyId             String    @map("company_id")

  email                 String
  passwordHash          String    @map("password_hash")

  firstName             String?   @map("first_name") @db.VarChar(100)
  lastName              String?   @map("last_name") @db.VarChar(100)
  role                  String    @default("member") @db.VarChar(50)

  canEditProfile        Boolean   @default(false) @map("can_edit_profile")
  canManageJobs         Boolean   @default(true) @map("can_manage_jobs")
  canChat               Boolean   @default(true) @map("can_chat")
  canManageTeam         Boolean   @default(false) @map("can_manage_team")
  canManageBilling      Boolean   @default(false) @map("can_manage_billing")

  emailVerified         Boolean   @default(false) @map("email_verified")
  emailVerifyToken      String?   @map("email_verify_token")

  passwordResetToken    String?   @map("password_reset_token")
  passwordResetExpires  DateTime? @map("password_reset_expires")

  refreshToken          String?   @map("refresh_token") @db.Text

  invitedAt             DateTime? @map("invited_at")
  joinedAt              DateTime? @map("joined_at")
  createdAt             DateTime  @default(now()) @map("created_at")
  lastLoginAt           DateTime? @map("last_login_at")

  company               Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyLikes          CompanyLike[]
  messages              Message[] @relation("CompanyUserMessages")
  notifications         Notification[]

  @@unique([companyId, email])
  @@index([companyId])
  @@map("company_users")
}

// ═══════════════════════════════════════════════════════════════════════════
// PROFESSIONS
// ═══════════════════════════════════════════════════════════════════════════

model Profession {
  id                    String    @id @default(uuid())

  code                  String?   @unique @db.VarChar(20)
  name                  String    @db.VarChar(255)
  slug                  String    @unique @db.VarChar(100)

  category              String?   @db.VarChar(100)
  subcategory           String?   @db.VarChar(100)
  tags                  Json?     @default("[]")

  description           String?   @db.Text
  shortDescription      String?   @map("short_description") @db.VarChar(300)
  tasks                 Json?     @default("[]")
  requirements          Json?     @default("[]")
  skills                Json?     @default("[]")

  durationMonths        Int?      @map("duration_months")
  schoolTypeMin         String?   @map("school_type_min") @db.VarChar(50)

  salaryYear1           Int?      @map("salary_year_1")
  salaryYear2           Int?      @map("salary_year_2")
  salaryYear3           Int?      @map("salary_year_3")
  salaryAfter           String?   @map("salary_after") @db.VarChar(50)

  careerPaths           Json?     @default("[]") @map("career_paths")

  iconUrl               String?   @map("icon_url") @db.VarChar(500)
  imageUrl              String?   @map("image_url") @db.VarChar(500)

  isActive              Boolean   @default(true) @map("is_active")

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  jobPosts              JobPost[]
  videos                Video[]

  @@index([category])
  @@map("professions")
}

// ═══════════════════════════════════════════════════════════════════════════
// JOB_POSTS - ERWEITERT
// ═══════════════════════════════════════════════════════════════════════════

model JobPost {
  id                    String    @id @default(uuid())
  companyId             String    @map("company_id")
  professionId          String?   @map("profession_id")

  title                 String    @db.VarChar(255)
  slug                  String?   @db.VarChar(150)

  description           String?   @db.Text
  requirements          String?   @db.Text
  benefits              String?   @db.Text

  startDate             DateTime? @map("start_date") @db.Date
  durationMonths        Int?      @map("duration_months")
  positionsAvailable    Int       @default(1) @map("positions_available")

  salaryYear1           Int?      @map("salary_year_1")
  salaryYear2           Int?      @map("salary_year_2")
  salaryYear3           Int?      @map("salary_year_3")

  postalCode            String?   @map("postal_code") @db.VarChar(10)
  city                  String?   @db.VarChar(100)
  latitude              Decimal?  @db.Decimal(10, 8)
  longitude             Decimal?  @db.Decimal(11, 8)

  // App-Konzept: Erweiterte Felder
  beruf                 String?   @db.VarChar(255)
  bereich               String?   @db.VarChar(50)
  anforderungen         Json?     @default("[]")
  gehalt                Json?
  arbeitszeit           String?   @db.VarChar(50)
  dauer                 String?   @db.VarChar(100)
  remote                Boolean   @default(false)
  standortAdresse       String?   @map("standort_adresse") @db.VarChar(255)
  bewerbungsfrist       DateTime?
  metaTitle             String?   @map("meta_title") @db.VarChar(70)
  metaDescription       String?   @map("meta_description") @db.VarChar(160)

  showOnWebsite         Boolean   @default(true) @map("show_on_website")

  status                JobStatus @default(DRAFT)

  viewCount             Int       @default(0) @map("view_count")
  likeCount             Int       @default(0) @map("like_count")
  matchCount            Int       @default(0) @map("match_count")

  // Multi-Portal (NEU)
  portalId              Int       @default(1) @map("portal_id")

  publishedAt           DateTime? @map("published_at")
  expiresAt             DateTime? @map("expires_at")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations (bestehend)
  company               Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  profession            Profession? @relation(fields: [professionId], references: [id])
  videos                Video[]
  likes                 Like[]
  matches               Match[]
  companyLikes          CompanyLike[]

  // Relations (NEU)
  portal                Portal    @relation(fields: [portalId], references: [id])
  videoJobPosts         VideoJobPost[]
  applications          Application[]
  publishedPortals      JobPostPortal[]

  // Premium Relations
  jobPostViews          JobPostView[]
  jobPostClicks         JobPostClick[]
  jobBoosts             JobBoost[]
  interviews            Interview[]
  interviewSlots        InterviewSlot[]

  @@index([companyId])
  @@index([professionId])
  @@index([status])
  @@map("job_posts")
}

// ═══════════════════════════════════════════════════════════════════════════
// VIDEOS
// ═══════════════════════════════════════════════════════════════════════════

model Video {
  id                    String    @id @default(uuid())
  companyId             String    @map("company_id")
  jobPostId             String?   @map("job_post_id")
  professionId          String?   @map("profession_id")

  title                 String?   @db.VarChar(255)
  description           String?   @db.Text

  filename              String    @db.VarChar(255)
  filepath              String    @db.VarChar(500)
  filesize              Int?
  mimeType              String?   @map("mime_type") @db.VarChar(50)

  processedPath         String?   @map("processed_path") @db.VarChar(500)
  thumbnailPath         String?   @map("thumbnail_path") @db.VarChar(500)
  storagePath           String?   @map("storage_path") @db.VarChar(500)

  durationSeconds       Int?      @map("duration_seconds")
  width                 Int?
  height                Int?

  videoType             String?   @map("video_type") @db.VarChar(50)
  featuredPerson        String?   @map("featured_person") @db.VarChar(100)

  status                VideoStatus @default(PROCESSING)
  moderationNote        String?   @map("moderation_note") @db.Text

  viewCount             Int       @default(0) @map("view_count")
  likeCount             Int       @default(0) @map("like_count")
  shareCount            Int       @default(0) @map("share_count")

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  publishedAt           DateTime? @map("published_at")

  // Moderation (NEU - App-Konzept)
  moderationStatus      ModerationStatus @default(PENDING) @map("moderation_status")

  company               Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  jobPost               JobPost?  @relation(fields: [jobPostId], references: [id])
  profession            Profession? @relation(fields: [professionId], references: [id])
  likes                 Like[]

  // M2M: Video kann mehreren Stellen zugeordnet sein (NEU - App-Konzept)
  videoJobPosts         VideoJobPost[]

  @@index([companyId])
  @@index([status])
  @@map("videos")
}

// ═══════════════════════════════════════════════════════════════════════════
// VIDEO_JOB_POSTS (Many-to-Many: Video ↔ JobPost) - NEU App-Konzept
// ═══════════════════════════════════════════════════════════════════════════

model VideoJobPost {
  id          String   @id @default(uuid())
  videoId     String   @map("video_id")
  jobPostId   String   @map("job_post_id")

  // Reihenfolge (welches Video zuerst bei der Stelle?)
  position    Int      @default(0)

  video       Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  jobPost     JobPost  @relation(fields: [jobPostId], references: [id], onDelete: Cascade)

  @@unique([videoId, jobPostId])
  @@map("video_job_posts")
}

// ═══════════════════════════════════════════════════════════════════════════
// JOB_POST_PORTALS (Many-to-Many: JobPost ↔ Portal - Multi-Portal Publishing)
// ═══════════════════════════════════════════════════════════════════════════

model JobPostPortal {
  id        String   @id @default(uuid())
  jobPostId String   @map("job_post_id")
  portalId  Int      @map("portal_id")

  jobPost   JobPost  @relation(fields: [jobPostId], references: [id], onDelete: Cascade)
  portal    Portal   @relation(fields: [portalId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([jobPostId, portalId])
  @@map("job_post_portals")
}

// ═══════════════════════════════════════════════════════════════════════════
// LIKES
// ═══════════════════════════════════════════════════════════════════════════

model Like {
  id                    String    @id @default(uuid())
  userId                String    @map("user_id")

  companyId             String?   @map("company_id")
  jobPostId             String?   @map("job_post_id")
  videoId               String?   @map("video_id")

  source                String?   @db.VarChar(50)

  createdAt             DateTime  @default(now()) @map("created_at")

  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  company               Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  jobPost               JobPost?  @relation(fields: [jobPostId], references: [id], onDelete: Cascade)
  video                 Video?    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId])
  @@unique([userId, jobPostId])
  @@unique([userId, videoId])
  @@index([userId])
  @@index([companyId])
  @@map("likes")
}

// ═══════════════════════════════════════════════════════════════════════════
// COMPANY_LIKES
// ═══════════════════════════════════════════════════════════════════════════

model CompanyLike {
  id                    String    @id @default(uuid())
  companyId             String    @map("company_id")
  userId                String    @map("user_id")
  jobPostId             String?   @map("job_post_id")

  likedById             String?   @map("liked_by_id")
  note                  String?   @db.Text

  createdAt             DateTime  @default(now()) @map("created_at")

  company               Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobPost               JobPost?  @relation(fields: [jobPostId], references: [id])
  likedBy               CompanyUser? @relation(fields: [likedById], references: [id])

  @@unique([companyId, userId])
  @@index([companyId])
  @@index([userId])
  @@map("company_likes")
}

// ═══════════════════════════════════════════════════════════════════════════
// MATCHES
// ═══════════════════════════════════════════════════════════════════════════

model Match {
  id                    String    @id @default(uuid())
  userId                String    @map("user_id")
  companyId             String    @map("company_id")
  jobPostId             String?   @map("job_post_id")

  initiatedBy           String?   @map("initiated_by") @db.VarChar(10)

  status                MatchStatus @default(ACTIVE)

  // App-Konzept: Erweiterte Match-Felder
  userLikedFirst        Boolean?  @map("user_liked_first")
  userLikedAt           DateTime? @map("user_liked_at")
  companyLikedAt        DateTime? @map("company_liked_at")

  matchedAt             DateTime  @default(now()) @map("matched_at")
  expiredAt             DateTime? @map("expired_at")

  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  company               Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  jobPost               JobPost?  @relation(fields: [jobPostId], references: [id])
  chat                  Chat?

  @@unique([userId, companyId])
  @@index([userId])
  @@index([companyId])
  @@map("matches")
}

// ═══════════════════════════════════════════════════════════════════════════
// CHATS
// ═══════════════════════════════════════════════════════════════════════════

model Chat {
  id                    String    @id @default(uuid())
  matchId               String    @unique @map("match_id")
  userId                String    @map("user_id")
  companyId             String    @map("company_id")

  isActive              Boolean   @default(true) @map("is_active")

  lastMessageAt         DateTime? @map("last_message_at")
  lastMessagePreview    String?   @map("last_message_preview") @db.VarChar(200)

  userUnreadCount       Int       @default(0) @map("user_unread_count")
  companyUnreadCount    Int       @default(0) @map("company_unread_count")

  createdAt             DateTime  @default(now()) @map("created_at")

  match                 Match     @relation(fields: [matchId], references: [id], onDelete: Cascade)
  user                  User      @relation(fields: [userId], references: [id])
  company               Company   @relation(fields: [companyId], references: [id])
  messages              Message[]

  @@index([userId])
  @@index([companyId])
  @@map("chats")
}

// ═══════════════════════════════════════════════════════════════════════════
// MESSAGES
// ═══════════════════════════════════════════════════════════════════════════

model Message {
  id                    String    @id @default(uuid())
  chatId                String    @map("chat_id")

  senderType            String    @map("sender_type") @db.VarChar(10)
  senderUserId          String?   @map("sender_user_id")
  senderCompanyUserId   String?   @map("sender_company_user_id")

  content               String    @db.Text
  messageType           MessageType @default(TEXT) @map("message_type")

  attachmentUrl         String?   @map("attachment_url") @db.VarChar(500)
  attachmentType        String?   @map("attachment_type") @db.VarChar(50)
  attachmentName        String?   @map("attachment_name") @db.VarChar(255)

  isRead                Boolean   @default(false) @map("is_read")
  readAt                DateTime? @map("read_at")
  isDeleted             Boolean   @default(false) @map("is_deleted")

  createdAt             DateTime  @default(now()) @map("created_at")
  editedAt              DateTime? @map("edited_at")

  chat                  Chat      @relation(fields: [chatId], references: [id], onDelete: Cascade)
  senderUser            User?     @relation("UserMessages", fields: [senderUserId], references: [id])
  senderCompanyUser     CompanyUser? @relation("CompanyUserMessages", fields: [senderCompanyUserId], references: [id])

  @@index([chatId])
  @@index([createdAt])
  @@map("messages")
}

// ═══════════════════════════════════════════════════════════════════════════
// SUBSCRIPTIONS - ERWEITERT
// ═══════════════════════════════════════════════════════════════════════════

model Subscription {
  id                    String    @id @default(uuid())
  companyId             String    @map("company_id")

  plan                  SubscriptionPlan
  status                SubscriptionStatus

  stripeSubscriptionId  String?   @map("stripe_subscription_id") @db.VarChar(100)
  stripePriceId         String?   @map("stripe_price_id") @db.VarChar(100)

  priceMonthly          Decimal?  @map("price_monthly") @db.Decimal(10, 2)
  currency              String    @default("EUR") @db.VarChar(3)

  currentPeriodStart    DateTime? @map("current_period_start")
  currentPeriodEnd      DateTime? @map("current_period_end")
  trialEnd              DateTime? @map("trial_end")

  cancelAt              DateTime? @map("cancel_at")
  canceledAt            DateTime? @map("canceled_at")

  // Multi-Portal (NEU)
  portalId              Int       @default(1) @map("portal_id")
  customerId            String?   @map("customer_id")

  // PayPal (NEU)
  paypalSubscriptionId  String?   @map("paypal_subscription_id") @db.VarChar(100)

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations (bestehend)
  company               Company   @relation(fields: [companyId], references: [id])

  // Relations (NEU)
  portal                Portal    @relation(fields: [portalId], references: [id])
  customer              Customer? @relation(fields: [customerId], references: [id])
  companyBereiche       CompanyBereich[]

  @@index([companyId])
  @@map("subscriptions")
}

// ═══════════════════════════════════════════════════════════════════════════
// NOTIFICATIONS
// ═══════════════════════════════════════════════════════════════════════════

model Notification {
  id                    String    @id @default(uuid())

  userId                String?   @map("user_id")
  companyUserId         String?   @map("company_user_id")

  type                  NotificationType
  title                 String    @db.VarChar(255)
  body                  String?   @db.Text

  referenceType         String?   @map("reference_type") @db.VarChar(50)
  referenceId           String?   @map("reference_id")

  isRead                Boolean   @default(false) @map("is_read")
  readAt                DateTime? @map("read_at")

  pushSent              Boolean   @default(false) @map("push_sent")
  pushSentAt            DateTime? @map("push_sent_at")

  createdAt             DateTime  @default(now()) @map("created_at")

  user                  User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyUser           CompanyUser? @relation(fields: [companyUserId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([companyUserId])
  @@map("notifications")
}

// ═══════════════════════════════════════════════════════════════════════════
// AI_CONVERSATIONS
// ═══════════════════════════════════════════════════════════════════════════

model AiConversation {
  id                    String    @id @default(uuid())
  userId                String?   @map("user_id")
  sessionId             String?   @map("session_id") @db.VarChar(100)
  portal                String?   @db.VarChar(50)

  messages              Json      @default("[]")
  suggestedProfessions  Json?     @map("suggested_professions")

  completed             Boolean   @default(false)
  questionCount         Int       @default(0) @map("question_count")

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  user                  User?     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("ai_conversations")
}

// ═══════════════════════════════════════════════════════════════════════════
// EVENTS (Analytics)
// ═══════════════════════════════════════════════════════════════════════════

model Event {
  id                    String    @id @default(uuid())

  userId                String?   @map("user_id")
  companyId             String?   @map("company_id")
  sessionId             String?   @map("session_id") @db.VarChar(100)

  eventType             String    @map("event_type") @db.VarChar(100)
  properties            Json?     @default("{}")

  platform              String?   @db.VarChar(20)
  appVersion            String?   @map("app_version") @db.VarChar(20)

  createdAt             DateTime  @default(now()) @map("created_at")

  user                  User?     @relation(fields: [userId], references: [id])
  company               Company?  @relation(fields: [companyId], references: [id])

  @@index([eventType])
  @@index([userId])
  @@index([createdAt])
  @@map("events")
}

// ═══════════════════════════════════════════════════════════════════════════
// ADMIN_USERS - ERWEITERT
// ═══════════════════════════════════════════════════════════════════════════

model AdminUser {
  id                    String    @id @default(uuid())

  email                 String    @unique
  passwordHash          String    @map("password_hash")
  name                  String?   @db.VarChar(255)
  role                  String    @default("support") @db.VarChar(50)

  // Erweiterte Felder (NEU)
  firstName             String?   @map("first_name") @db.VarChar(100)
  lastName              String?   @map("last_name") @db.VarChar(100)
  avatarUrl             String?   @map("avatar_url") @db.VarChar(500)

  // Portal-Zugriff (null = alle Portale)
  portalAccess          Json?     @map("portal_access")

  permissions           Json?     @default("{}")

  refreshToken          String?   @map("refresh_token") @db.Text

  // Status (NEU)
  isActive              Boolean   @default(true) @map("is_active")

  createdAt             DateTime  @default(now()) @map("created_at")
  lastLoginAt           DateTime? @map("last_login_at")

  // Relations (NEU)
  auditLogs             AuditLog[]

  @@map("admin_users")
}

// ═══════════════════════════════════════════════════════════════════════════
// EMAIL LOG
// ═══════════════════════════════════════════════════════════════════════════

enum EmailStatus {
  SENT
  FAILED
  BOUNCED
  DELIVERED
}

// ═══════════════════════════════════════════════════════════════════════════
// ENTERPRISE ENUMS
// ═══════════════════════════════════════════════════════════════════════════

enum ImportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum ExternalJobSource {
  ADZUNA
  JOOBLE
  CAREERJET
}

enum ApplicationStatus {
  NEW
  VIEWED
  SHORTLISTED
  INTERVIEW
  OFFER
  HIRED
  REJECTED
  WITHDRAWN
}

enum ApplicationSource {
  WEBSITE
  APP
  EMBED
  API
}

enum DocumentType {
  LEBENSLAUF
  ANSCHREIBEN
  ZEUGNIS
  ZERTIFIKAT
  SONSTIGES
}

// ═══════════════════════════════════════════════════════════════════════════
// USER_DOCUMENTS (Lebenslauf, Zeugnisse etc.)
// ═══════════════════════════════════════════════════════════════════════════

model UserDocument {
  id            String       @id @default(uuid())
  userId        String       @map("user_id")
  dokumentTyp   DocumentType @default(SONSTIGES) @map("dokument_typ")
  name          String       @db.VarChar(255)
  filename      String       @db.VarChar(255)
  originalName  String       @map("original_name") @db.VarChar(255)
  mimeType      String       @map("mime_type") @db.VarChar(100)
  fileSize      Int          @map("file_size")
  storagePath   String       @map("storage_path") @db.VarChar(500)

  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_documents")
}

model EmailLog {
  id          String      @id @default(uuid())

  to          String      @db.VarChar(255)
  template    String      @db.VarChar(100)
  subject     String      @db.VarChar(500)

  status      EmailStatus @default(SENT)
  messageId   String?     @map("message_id") @db.VarChar(500)
  error       String?     @db.Text

  portalId    Int?        @map("portal_id")

  sentAt      DateTime    @default(now()) @map("sent_at")

  @@index([to])
  @@index([template])
  @@index([sentAt])
  @@map("email_logs")
}

// ═══════════════════════════════════════════════════════════════════════════
// COUPONS (Gutschein-System)
// ═══════════════════════════════════════════════════════════════════════════

model Coupon {
  id              String           @id @default(uuid())
  code            String           @unique @db.VarChar(50)
  planType        SubscriptionPlan @default(PRO) @map("plan_type")
  durationMonths  Int              @default(3) @map("duration_months")
  description     String?          @db.VarChar(255)
  campaign        String?          @db.VarChar(100)
  maxRedemptions  Int?             @map("max_redemptions")
  redemptionCount Int              @default(0) @map("redemption_count")
  validFrom       DateTime         @default(now()) @map("valid_from")
  validUntil      DateTime?        @map("valid_until")
  isActive        Boolean          @default(true) @map("is_active")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")

  redemptions     CouponRedemption[]

  @@index([code])
  @@map("coupons")
}

model CouponRedemption {
  id            String           @id @default(uuid())
  couponId      String           @map("coupon_id")
  companyId     String           @map("company_id")
  planType      SubscriptionPlan @map("plan_type")
  startDate     DateTime         @default(now()) @map("start_date")
  endDate       DateTime         @map("end_date")
  redeemedAt    DateTime         @default(now()) @map("redeemed_at")
  redeemedByIp  String?          @db.VarChar(50) @map("redeemed_by_ip")

  coupon        Coupon           @relation(fields: [couponId], references: [id])
  company       Company          @relation(fields: [companyId], references: [id])

  @@unique([couponId, companyId])
  @@map("coupon_redemptions")
}

// ═══════════════════════════════════════════════════════════════════════════
// IMPORT_LOG (CSV-Import Tracking) - Enterprise
// ═══════════════════════════════════════════════════════════════════════════

model ImportLog {
  id              String       @id @default(uuid())
  companyId       String       @map("company_id")

  filename        String       @db.VarChar(255)
  fileSize        Int          @default(0) @map("file_size")
  status          ImportStatus @default(PENDING)

  totalRows       Int          @default(0) @map("total_rows")
  importedCount   Int          @default(0) @map("imported_count")
  updatedCount    Int          @default(0) @map("updated_count")
  skippedCount    Int          @default(0) @map("skipped_count")
  errorCount      Int          @default(0) @map("error_count")

  columnMapping   Json?        @map("column_mapping")
  errorDetails    Json?        @map("error_details")
  mode            String       @default("ADD") @db.VarChar(20)

  createdAt       DateTime     @default(now()) @map("created_at")
  completedAt     DateTime?    @map("completed_at")

  company         Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("import_logs")
}

// ═══════════════════════════════════════════════════════════════════════════
// APPLICATION (Bewerbungen) - Enterprise
// ═══════════════════════════════════════════════════════════════════════════

model Application {
  id                    String            @id @default(uuid())
  jobPostId             String            @map("job_post_id")
  companyId             String            @map("company_id")
  userId                String?           @map("user_id")

  firstName             String            @map("first_name") @db.VarChar(100)
  lastName              String            @map("last_name") @db.VarChar(100)
  email                 String            @db.VarChar(255)
  phone                 String?           @db.VarChar(30)

  birthDate             DateTime?         @map("birth_date") @db.Date
  postalCode            String?           @map("postal_code") @db.VarChar(10)
  city                  String?           @db.VarChar(100)

  message               String?           @db.Text
  anschreiben           String?           @db.Text
  schulabschluss        String?           @db.VarChar(100)
  abschlussjahr         Int?
  notendurchschnitt     Decimal?          @db.Decimal(3, 1)
  berufserfahrungJahre  Int?              @map("berufserfahrung_jahre")
  gehaltsvorstellung    String?           @db.VarChar(50)
  fruehesterStart       DateTime?         @map("fruehester_start") @db.Date
  customFields          Json?             @map("custom_fields")

  sourceChannel         String?           @map("source_channel") @db.VarChar(100)
  newsletterOptIn       Boolean           @default(false) @map("newsletter_opt_in")

  status                ApplicationStatus @default(NEW)
  source                ApplicationSource @default(WEBSITE)
  interneNotizen        String?           @map("interne_notizen") @db.Text
  rating                Int?

  datenschutzAkzeptiert Boolean           @default(false) @map("datenschutz_akzeptiert")

  portalId              Int               @default(1) @map("portal_id")

  createdAt             DateTime          @default(now()) @map("created_at")
  updatedAt             DateTime          @updatedAt @map("updated_at")

  jobPost               JobPost           @relation(fields: [jobPostId], references: [id], onDelete: Cascade)
  company               Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  documents             ApplicationDocument[]
  interviews            Interview[]

  @@index([companyId])
  @@index([jobPostId])
  @@index([status])
  @@index([email])
  @@map("applications")
}

// ═══════════════════════════════════════════════════════════════════════════
// APPLICATION_DOCUMENT (Bewerbungsdokumente) - Enterprise
// ═══════════════════════════════════════════════════════════════════════════

model ApplicationDocument {
  id              String       @id @default(uuid())
  applicationId   String       @map("application_id")

  dokumentTyp     DocumentType @default(SONSTIGES) @map("dokument_typ")
  filename        String       @db.VarChar(255)
  originalName    String       @map("original_name") @db.VarChar(255)
  mimeType        String       @map("mime_type") @db.VarChar(100)
  fileSize        Int          @map("file_size")
  storagePath     String       @map("storage_path") @db.VarChar(500)

  createdAt       DateTime     @default(now()) @map("created_at")

  application     Application  @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@map("application_documents")
}

// ═══════════════════════════════════════════════════════════════════════════
// APPLICATION_FORM_CONFIG (Formular-Konfiguration pro Firma) - Enterprise
// ═══════════════════════════════════════════════════════════════════════════

model ApplicationFormConfig {
  id                      String   @id @default(uuid())
  companyId               String   @unique @map("company_id")

  activeFields            Json     @default("[\"firstName\",\"lastName\",\"email\",\"message\"]") @map("active_fields")
  requiredFields          Json     @default("[\"firstName\",\"lastName\",\"email\"]") @map("required_fields")
  customFields            Json     @default("[]") @map("custom_fields")

  allowAppApplication     Boolean  @default(true) @map("allow_app_application")
  allowWebsiteApplication Boolean  @default(true) @map("allow_website_application")
  externalApplicationUrl  String?  @map("external_application_url") @db.VarChar(500)

  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  company                 Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("application_form_configs")
}

// ═══════════════════════════════════════════════════════════════════════════
// API_KEY (API-Schluessel) - Enterprise
// ═══════════════════════════════════════════════════════════════════════════

model ApiKey {
  id              String    @id @default(uuid())
  companyId       String    @map("company_id")

  name            String    @db.VarChar(100)
  keyPrefix       String    @map("key_prefix") @db.VarChar(12)
  keyHash         String    @unique @map("key_hash") @db.VarChar(64)

  permissions     Json      @default("[\"read\"]")
  rateLimit       Int       @default(1000) @map("rate_limit")
  allowedIps      Json?     @map("allowed_ips")
  allowedDomains  Json?     @map("allowed_domains")

  isActive        Boolean   @default(true) @map("is_active")
  lastUsedAt      DateTime? @map("last_used_at")
  expiresAt       DateTime? @map("expires_at")

  createdAt       DateTime  @default(now()) @map("created_at")

  company         Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  usageLogs       ApiUsageLog[]

  @@index([companyId])
  @@index([keyHash])
  @@map("api_keys")
}

// ═══════════════════════════════════════════════════════════════════════════
// API_USAGE_LOG (API-Nutzung) - Enterprise
// ═══════════════════════════════════════════════════════════════════════════

model ApiUsageLog {
  id              String   @id @default(uuid())
  apiKeyId        String   @map("api_key_id")

  endpoint        String   @db.VarChar(255)
  method          String   @db.VarChar(10)
  statusCode      Int      @map("status_code")
  ip              String?  @db.VarChar(45)
  responseTimeMs  Int?     @map("response_time_ms")

  createdAt       DateTime @default(now()) @map("created_at")

  apiKey          ApiKey   @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)

  @@index([apiKeyId])
  @@index([createdAt])
  @@map("api_usage_logs")
}

// ═══════════════════════════════════════════════════════════════════════════
// WEBHOOK (Webhook-Konfiguration) - Enterprise
// ═══════════════════════════════════════════════════════════════════════════

model Webhook {
  id              String    @id @default(uuid())
  companyId       String    @map("company_id")

  url             String    @db.VarChar(500)
  events          Json      @default("[\"application.created\"]")
  secret          String    @db.VarChar(64)

  isActive        Boolean   @default(true) @map("is_active")
  lastTriggeredAt DateTime? @map("last_triggered_at")
  failureCount    Int       @default(0) @map("failure_count")

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  company         Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("webhooks")
}

// ═══════════════════════════════════════════════════════════════════════════
// JOB_ALERT (Job-Benachrichtigungen) - Premium Feature
// ═══════════════════════════════════════════════════════════════════════════

model JobAlert {
  id                String         @id @default(uuid())
  userId            String?        @map("user_id")
  email             String         @db.VarChar(255)

  name              String?        @db.VarChar(100)

  // Suchfilter
  keywords          String?        @db.VarChar(255)
  professionIds     Json?          @map("profession_ids")
  bereich           String?        @db.VarChar(50)
  postalCode        String?        @map("postal_code") @db.VarChar(10)
  city              String?        @db.VarChar(100)
  radiusKm          Int?           @default(50) @map("radius_km")
  remote            Boolean?

  frequency         AlertFrequency @default(DAILY)
  isActive          Boolean        @default(true) @map("is_active")
  isVerified        Boolean        @default(false) @map("is_verified")
  verifyToken       String?        @map("verify_token") @db.VarChar(100)
  unsubscribeToken  String         @map("unsubscribe_token") @db.VarChar(100)

  lastSentAt        DateTime?      @map("last_sent_at")
  sentCount         Int            @default(0) @map("sent_count")
  matchCount        Int            @default(0) @map("match_count")

  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")

  user              User?          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([email])
  @@index([isActive, frequency])
  @@map("job_alerts")
}

// ═══════════════════════════════════════════════════════════════════════════
// NEWSLETTER_SUBSCRIBER (App-Launch-Benachrichtigungen)
// ═══════════════════════════════════════════════════════════════════════════

model NewsletterSubscriber {
  id                String    @id @default(uuid())
  email             String    @db.VarChar(255)

  // Quell-Domain (z.B. werkstudentengenie.de)
  domain            String    @db.VarChar(100)

  // Double-Opt-In Tokens
  verifyToken       String?   @map("verify_token") @db.VarChar(100)
  unsubscribeToken  String    @map("unsubscribe_token") @db.VarChar(100)

  isVerified        Boolean   @default(false) @map("is_verified")
  isActive          Boolean   @default(true) @map("is_active")

  createdAt         DateTime  @default(now()) @map("created_at")
  verifiedAt        DateTime? @map("verified_at")

  @@unique([email, domain])
  @@index([email])
  @@index([isActive])
  @@map("newsletter_subscribers")
}

// ═══════════════════════════════════════════════════════════════════════════
// NEWSLETTER_CAMPAIGN (Newsletter-Kampagnen für Admin-Versand)
// ═══════════════════════════════════════════════════════════════════════════

model NewsletterCampaign {
  id              String    @id @default(uuid())
  subject         String    @db.VarChar(500)
  htmlContent     String    @map("html_content") @db.Text

  // Zielgruppen: kommaseparierte Domain-Liste (z.B. "werkstudentengenie.de,berufsgenie.de")
  // Leer/null = alle Domains
  targetDomains   String?   @map("target_domains") @db.VarChar(1000)

  status          String    @default("DRAFT") @db.VarChar(20) // DRAFT | SENDING | SENT | FAILED

  // Versand-Statistiken
  totalRecipients Int       @default(0) @map("total_recipients")
  sentCount       Int       @default(0) @map("sent_count")
  failedCount     Int       @default(0) @map("failed_count")

  sentAt          DateTime? @map("sent_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@index([status])
  @@index([createdAt])
  @@map("newsletter_campaigns")
}

// ═══════════════════════════════════════════════════════════════════════════
// COMPANY_REVIEW (Arbeitgeber-Bewertungen) - Premium Feature
// ═══════════════════════════════════════════════════════════════════════════

model CompanyReview {
  id                String       @id @default(uuid())
  companyId         String       @map("company_id")
  userId            String       @map("user_id")

  // Bewertung (1-5 Sterne)
  overallRating     Int          @map("overall_rating")
  cultureRating     Int?         @map("culture_rating")
  tasksRating       Int?         @map("tasks_rating")
  supervisorRating  Int?         @map("supervisor_rating")
  salaryRating      Int?         @map("salary_rating")

  title             String       @db.VarChar(200)
  pros              String       @db.Text
  cons              String       @db.Text

  reviewerType      ReviewerType
  department        String?      @db.VarChar(100)
  isAnonymous       Boolean      @default(true) @map("is_anonymous")
  wouldRecommend    Boolean      @default(true) @map("would_recommend")

  status            ReviewStatus @default(REVIEW_PENDING)
  moderationNote    String?      @map("moderation_note") @db.Text

  helpfulCount      Int          @default(0) @map("helpful_count")

  // Firmen-Antwort
  companyResponse    String?     @map("company_response") @db.Text
  companyRespondedAt DateTime?   @map("company_responded_at")

  createdAt         DateTime     @default(now()) @map("created_at")
  updatedAt         DateTime     @updatedAt @map("updated_at")

  company           Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  helpfuls          ReviewHelpful[]

  @@unique([companyId, userId])
  @@index([companyId])
  @@index([status])
  @@map("company_reviews")
}

// ═══════════════════════════════════════════════════════════════════════════
// REVIEW_HELPFUL (Bewertung hilfreich) - Premium Feature
// ═══════════════════════════════════════════════════════════════════════════

model ReviewHelpful {
  id          String        @id @default(uuid())
  reviewId    String        @map("review_id")
  userId      String        @map("user_id")

  createdAt   DateTime      @default(now()) @map("created_at")

  review      CompanyReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([reviewId, userId])
  @@map("review_helpfuls")
}

// ═══════════════════════════════════════════════════════════════════════════
// COMPANY_FOLLOW (Firmen folgen) - Premium Feature
// ═══════════════════════════════════════════════════════════════════════════

model CompanyFollow {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  companyId   String   @map("company_id")

  notify      Boolean  @default(true)

  createdAt   DateTime @default(now()) @map("created_at")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId])
  @@index([companyId])
  @@map("company_follows")
}

// ═══════════════════════════════════════════════════════════════════════════
// SALARY_DATA (Gehaltsdaten) - Premium Feature
// ═══════════════════════════════════════════════════════════════════════════

model SalaryData {
  id              String       @id @default(uuid())
  companyId       String?      @map("company_id")
  userId          String?      @map("user_id")

  professionName  String       @map("profession_name") @db.VarChar(255)
  postalCode      String?      @map("postal_code") @db.VarChar(10)
  city            String?      @db.VarChar(100)
  region          String?      @db.VarChar(100)

  salaryType      SalaryType   @default(MONTHLY) @map("salary_type")
  amount          Decimal      @db.Decimal(10, 2)
  year            Int?

  source          SalarySource @default(USER_SUBMITTED)
  isVerified      Boolean      @default(false) @map("is_verified")

  createdAt       DateTime     @default(now()) @map("created_at")

  company         Company?     @relation(fields: [companyId], references: [id])
  user            User?        @relation(fields: [userId], references: [id])

  @@index([professionName])
  @@index([city])
  @@map("salary_data")
}

// ═══════════════════════════════════════════════════════════════════════════
// SALARY_STATISTICS (Gehalts-Aggregate pro Beruf/Region) - Premium Feature
// ═══════════════════════════════════════════════════════════════════════════

model SalaryStatistics {
  id              String   @id @default(uuid())
  companyId       String?  @map("company_id")

  professionName  String   @map("profession_name") @db.VarChar(255)
  region          String?  @db.VarChar(100)

  sampleCount     Int      @default(0) @map("sample_count")
  minSalary       Decimal  @default(0) @map("min_salary") @db.Decimal(10, 2)
  maxSalary       Decimal  @default(0) @map("max_salary") @db.Decimal(10, 2)
  avgSalary       Decimal  @default(0) @map("avg_salary") @db.Decimal(10, 2)
  medianSalary    Decimal  @default(0) @map("median_salary") @db.Decimal(10, 2)

  updatedAt       DateTime @updatedAt @map("updated_at")

  company         Company? @relation(fields: [companyId], references: [id])

  @@unique([professionName, region])
  @@map("salary_statistics")
}

// ═══════════════════════════════════════════════════════════════════════════
// JOB_POST_VIEW (Stellen-Aufrufe) - Premium Feature
// ═══════════════════════════════════════════════════════════════════════════

model JobPostView {
  id          String     @id @default(uuid())
  jobPostId   String     @map("job_post_id")
  companyId   String     @map("company_id")
  userId      String?    @map("user_id")

  source      ViewSource @default(WEBSITE_SOURCE)
  sessionId   String?    @map("session_id") @db.VarChar(100)
  ip          String?    @db.VarChar(45)
  userAgent   String?    @map("user_agent") @db.VarChar(500)
  referer     String?    @db.VarChar(500)

  createdAt   DateTime   @default(now()) @map("created_at")

  jobPost     JobPost    @relation(fields: [jobPostId], references: [id], onDelete: Cascade)
  company     Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user        User?      @relation(fields: [userId], references: [id])

  @@index([jobPostId])
  @@index([companyId])
  @@index([createdAt])
  @@map("job_post_views")
}

// ═══════════════════════════════════════════════════════════════════════════
// JOB_POST_CLICK (Stellen-Klicks) - Premium Feature
// ═══════════════════════════════════════════════════════════════════════════

model JobPostClick {
  id          String    @id @default(uuid())
  jobPostId   String    @map("job_post_id")
  companyId   String    @map("company_id")
  userId      String?   @map("user_id")

  clickType   ClickType
  sessionId   String?   @map("session_id") @db.VarChar(100)

  createdAt   DateTime  @default(now()) @map("created_at")

  jobPost     JobPost   @relation(fields: [jobPostId], references: [id], onDelete: Cascade)
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user        User?     @relation(fields: [userId], references: [id])

  @@index([jobPostId])
  @@index([companyId])
  @@index([createdAt])
  @@map("job_post_clicks")
}

// ═══════════════════════════════════════════════════════════════════════════
// INTERVIEW_SLOT (Zeitfenster für Interviews) - Premium Feature
// ═══════════════════════════════════════════════════════════════════════════

model InterviewSlot {
  id            String    @id @default(uuid())
  companyId     String    @map("company_id")
  jobPostId     String?   @map("job_post_id")

  date          DateTime  @db.Date
  startTime     String    @map("start_time") @db.VarChar(5)
  endTime       String    @map("end_time") @db.VarChar(5)

  durationMin   Int       @default(30) @map("duration_min")

  isBooked      Boolean   @default(false) @map("is_booked")
  isActive      Boolean   @default(true) @map("is_active")

  createdAt     DateTime  @default(now()) @map("created_at")

  company       Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  jobPost       JobPost?  @relation(fields: [jobPostId], references: [id])
  interview     Interview?

  @@index([companyId])
  @@index([date])
  @@map("interview_slots")
}

// ═══════════════════════════════════════════════════════════════════════════
// INTERVIEW (Interview-Termine) - Premium Feature
// ═══════════════════════════════════════════════════════════════════════════

model Interview {
  id              String          @id @default(uuid())
  slotId          String          @unique @map("slot_id")
  applicationId   String          @map("application_id")
  companyId       String          @map("company_id")
  jobPostId       String?         @map("job_post_id")

  type            InterviewType   @default(IN_PERSON)
  status          InterviewStatus @default(INTERVIEW_PENDING)

  location        String?         @db.VarChar(500)
  meetingUrl      String?         @map("meeting_url") @db.VarChar(500)

  notes           String?         @db.Text
  feedback        String?         @db.Text
  rating          Int?

  reminderSent    Boolean         @default(false) @map("reminder_sent")

  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  slot            InterviewSlot   @relation(fields: [slotId], references: [id])
  application     Application     @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  company         Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  jobPost         JobPost?        @relation(fields: [jobPostId], references: [id])

  @@index([applicationId])
  @@index([companyId])
  @@map("interviews")
}

// ═══════════════════════════════════════════════════════════════════════════
// CAREER_FINDER_RESULT (KI-Berufsfinder-Ergebnisse)
// ═══════════════════════════════════════════════════════════════════════════

model CareerFinderResult {
  id                String   @id @default(uuid())
  userId            String?  @map("user_id")
  sessionId         String?  @map("session_id") @db.VarChar(100)

  answers           Json     @default("[]")
  suggestedJobs     Json     @default("[]") @map("suggested_jobs")
  matchScores       Json     @default("{}") @map("match_scores")

  topProfession     String?  @map("top_profession") @db.VarChar(255)
  confidence        Decimal? @db.Decimal(5, 2)

  completedSteps    Int      @default(0) @map("completed_steps")
  totalSteps        Int      @default(10) @map("total_steps")

  createdAt         DateTime @default(now()) @map("created_at")

  user              User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("career_finder_results")
}

// ═══════════════════════════════════════════════════════════════════════════
// JOB_BOOST (Sponsored Jobs) - KI Feature
// ═══════════════════════════════════════════════════════════════════════════

model JobBoost {
  id            String      @id @default(uuid())
  jobPostId     String      @map("job_post_id")
  companyId     String      @map("company_id")

  type          BoostType   @default(BOOST)
  status        BoostStatus @default(BOOST_PENDING)

  pricePerWeek  Decimal     @map("price_per_week") @db.Decimal(10, 2)
  totalPrice    Decimal     @map("total_price") @db.Decimal(10, 2)
  currency      String      @default("EUR") @db.VarChar(3)

  startDate     DateTime    @map("start_date")
  endDate       DateTime    @map("end_date")

  impressions   Int         @default(0)
  clicks        Int         @default(0)
  applications  Int         @default(0)

  stripePaymentId String?   @map("stripe_payment_id") @db.VarChar(100)

  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  jobPost       JobPost     @relation(fields: [jobPostId], references: [id], onDelete: Cascade)
  company       Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([jobPostId])
  @@index([companyId])
  @@index([status])
  @@map("job_boosts")
}

// ═══════════════════════════════════════════════════════════════════════════
// TALENT_POOL (Talent-Pool) - KI Feature
// ═══════════════════════════════════════════════════════════════════════════

model TalentPool {
  id          String       @id @default(uuid())
  companyId   String       @map("company_id")
  userId      String       @map("user_id")

  source      TalentSource @default(MANUAL)
  tags        Json         @default("[]")
  notes       String?      @db.Text
  rating      Int?

  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  company     Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([companyId, userId])
  @@index([companyId])
  @@map("talent_pools")
}

// ═══════════════════════════════════════════════════════════════════════════
// ACHIEVEMENT (Achievement-Definitionen) - Gamification
// ═══════════════════════════════════════════════════════════════════════════

model Achievement {
  id            String              @id @default(uuid())

  slug          String              @unique @db.VarChar(100)
  name          String              @db.VarChar(200)
  description   String              @db.VarChar(500)
  icon          String              @db.VarChar(10)

  category      AchievementCategory
  rarity        AchievementRarity   @default(COMMON)
  xpReward      Int                 @default(0) @map("xp_reward")

  // Bedingung (z.B. {"type":"profile_complete","threshold":100})
  condition     Json                @default("{}")

  isActive      Boolean             @default(true) @map("is_active")
  sortOrder     Int                 @default(0) @map("sort_order")

  createdAt     DateTime            @default(now()) @map("created_at")

  userAchievements UserAchievement[]

  @@map("achievements")
}

// ═══════════════════════════════════════════════════════════════════════════
// USER_ACHIEVEMENT (Freigeschaltete Achievements) - Gamification
// ═══════════════════════════════════════════════════════════════════════════

model UserAchievement {
  id              String      @id @default(uuid())
  userId          String      @map("user_id")
  achievementId   String      @map("achievement_id")

  unlockedAt      DateTime    @default(now()) @map("unlocked_at")
  progress        Int         @default(100)

  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement     Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId])
  @@map("user_achievements")
}

// ═══════════════════════════════════════════════════════════════════════════
// FRIENDSHIP (Buddy-System) - Social Feature
// ═══════════════════════════════════════════════════════════════════════════

model Friendship {
  id          String           @id @default(uuid())
  senderId    String           @map("sender_id")
  receiverId  String           @map("receiver_id")

  status      FriendshipStatus @default(FRIENDSHIP_PENDING)

  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  sender      User             @relation("FriendshipSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver    User             @relation("FriendshipReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  @@unique([senderId, receiverId])
  @@index([receiverId])
  @@map("friendships")
}

// ═══════════════════════════════════════════════════════════════════════════
// JOB_RECOMMENDATION (Job-Empfehlungen an Freunde) - Social Feature
// ═══════════════════════════════════════════════════════════════════════════

model JobRecommendation {
  id          String   @id @default(uuid())
  senderId    String   @map("sender_id")
  receiverId  String   @map("receiver_id")
  jobPostId   String   @map("job_post_id")

  message     String?  @db.VarChar(500)
  isRead      Boolean  @default(false) @map("is_read")

  createdAt   DateTime @default(now()) @map("created_at")

  sender      User     @relation("RecommendationSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver    User     @relation("RecommendationReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([receiverId])
  @@map("job_recommendations")
}

// ═══════════════════════════════════════════════════════════════════════════
// REFERRAL_CODE (Empfehlungscodes) - Social Feature
// ═══════════════════════════════════════════════════════════════════════════

model ReferralCode {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")

  code            String   @unique @db.VarChar(20)
  usageCount      Int      @default(0) @map("usage_count")
  maxUsages       Int?     @map("max_usages")
  xpPerReferral   Int      @default(50) @map("xp_per_referral")

  isActive        Boolean  @default(true) @map("is_active")

  createdAt       DateTime @default(now()) @map("created_at")

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([code])
  @@map("referral_codes")
}

// ═══════════════════════════════════════════════════════════════════════════
// SKILL_TEST (Skill-Tests) - Social Feature
// ═══════════════════════════════════════════════════════════════════════════

model SkillTest {
  id            String           @id @default(uuid())

  slug          String           @unique @db.VarChar(100)
  name          String           @db.VarChar(200)
  description   String?          @db.Text
  icon          String?          @db.VarChar(10)

  category      String           @db.VarChar(100)
  difficulty    String           @default("mittel") @db.VarChar(20)
  durationMin   Int              @default(10) @map("duration_min")

  questions     Json             @default("[]")
  passingScore  Int              @default(70) @map("passing_score")

  isActive      Boolean          @default(true) @map("is_active")

  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")

  results       SkillTestResult[]

  @@map("skill_tests")
}

// ═══════════════════════════════════════════════════════════════════════════
// SKILL_TEST_RESULT (Skill-Test-Ergebnisse) - Social Feature
// ═══════════════════════════════════════════════════════════════════════════

model SkillTestResult {
  id            String    @id @default(uuid())
  userId        String    @map("user_id")
  skillTestId   String    @map("skill_test_id")

  score         Int
  passed        Boolean   @default(false)
  answers       Json      @default("[]")
  timeSpentSec  Int?      @map("time_spent_sec")

  xpEarned      Int       @default(0) @map("xp_earned")

  completedAt   DateTime  @default(now()) @map("completed_at")

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  skillTest     SkillTest @relation(fields: [skillTestId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([skillTestId])
  @@map("skill_test_results")
}

// ═══════════════════════════════════════════════════════════════════════════
// EXTERNAL JOBS (Adzuna + Jooble + Careerjet Import)
// ═══════════════════════════════════════════════════════════════════════════

model ExternalJob {
  id              String            @id @default(uuid())

  // Quelle
  source          ExternalJobSource
  sourceId        String            @map("source_id") @db.VarChar(255)

  // Stellendaten
  title           String            @db.VarChar(500)
  slug            String            @db.VarChar(300)
  description     String?           @db.Text
  companyName     String?           @map("company_name") @db.VarChar(255)

  // Ort
  city            String?           @db.VarChar(100)
  postalCode      String?           @map("postal_code") @db.VarChar(10)
  latitude        Decimal?          @db.Decimal(10, 8)
  longitude       Decimal?          @db.Decimal(11, 8)

  // Gehalt
  salaryMin       Int?              @map("salary_min")
  salaryMax       Int?              @map("salary_max")
  salaryUnit      String?           @map("salary_unit") @db.VarChar(10)

  // Klassifizierung
  category        String?           @db.VarChar(100)
  categoryTag     String?           @map("category_tag") @db.VarChar(100)
  jobType         String            @map("job_type") @db.VarChar(30)
  portalId        Int               @map("portal_id")

  // Affiliate-Link
  externalUrl     String            @map("external_url") @db.VarChar(2000)

  // Zeitstempel
  publishedAt     DateTime?         @map("published_at")
  expiresAt       DateTime?         @map("expires_at")
  lastSeenAt      DateTime          @default(now()) @map("last_seen_at")

  // Status
  isActive        Boolean           @default(true) @map("is_active")

  // Deduplizierung
  titleHash       String            @map("title_hash") @db.VarChar(64)

  // Analytics
  clickCount      Int               @default(0) @map("click_count")

  // Timestamps
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  // Relations
  portal          Portal            @relation(fields: [portalId], references: [id])

  @@unique([source, sourceId])
  @@index([portalId, isActive])
  @@index([city])
  @@index([jobType])
  @@index([titleHash])
  @@index([publishedAt])
  @@map("external_jobs")
}

model ExternalJobImportLog {
  id               String            @id @default(uuid())
  source           ExternalJobSource
  portalId         Int?              @map("portal_id")
  jobType          String?           @map("job_type") @db.VarChar(30)

  status           ImportStatus      @default(PROCESSING)

  totalFetched     Int               @default(0) @map("total_fetched")
  newCount         Int               @default(0) @map("new_count")
  updatedCount     Int               @default(0) @map("updated_count")
  skippedCount     Int               @default(0) @map("skipped_count")
  errorCount       Int               @default(0) @map("error_count")

  errorDetails     Json?             @map("error_details")
  durationMs       Int?              @map("duration_ms")

  startedAt        DateTime          @default(now()) @map("started_at")
  completedAt      DateTime?         @map("completed_at")

  @@index([source])
  @@index([startedAt])
  @@map("external_job_import_logs")
}
